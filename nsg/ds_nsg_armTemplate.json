{
    "$schema": "https://raw.githubusercontent.com/FabienGilbert/AzureHub/master/nsg/nsg_armTemplate_schema.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "RegionPrefix": {
            "type": "string",
            "metadata": {
                "description": "Specify the Region prefix that will be added to all Resource Group and Resource names."
            }
        },
        "LogWksRegionPrefix": {
            "type": "string",
            "metadata": {
                "description": "Specify the Region prefix that will be added to the Log Analytics Resource Group."
            }
        },
        "EnterprisePrefix": {
            "type": "string",
            "metadata": {
                "description": "Specify the enterpise prefix that will be added to all Resource Group and Resource names.."
            }
        },
        "EnvironmentPrefix": {
            "type": "string",
            "metadata": {
                "description": "Specify the environment prefix that will be added to all Resource Group and Resource names.."
            },
            "allowedValues": [
                "C",
                "D",
                "T",
                "L"
            ]
        },
        "SubscriptionOrdinalPrefix": {
            "type": "string",
            "metadata": {
                "description": "Specify the subscription ordinal prefix that will be added to all Resource Group and Resource names. For instance: S01"
            }
        },
        "firewallSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Azure Firewall VNET subnet prefix."
            }
        },
        "addsSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "AD FS VNET subnet prefix."
            }
        },
        "jumpSrvSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Jump server VNET subnet prefix."
            }
        },
        "environmentSupernet": {
            "type": "string",
            "metadata": {
                "description": "Supernet that includes all subnets in use in the environment."
            }
        },
        "adfsSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Edge VNET subnet prefix."
            }
        },
        "appSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "App VNET subnet prefix."
            }
        },
        "wapSubnetPrefix": {
            "type": "string",
            "metadata": {
                "description": "Web Application Proxy VNET subnet prefix."
            }
        },
        "dnsServers": {
            "type": "array",
            "metadata": {
                "description": "DNS Servers that will be configured in the VNET."
            }
        },
        "allowedOnPremsPublicIps": {
            "type": "array",
            "metadata": {
                "description": "On-premises Public IP Addresses allowed to connect through resources' firewall"
            },
            "defaultValue": []
        },
        "applicationTag": {
            "type": "string",
            "metadata": {
                "description": "Application tag"
            }
        },
        "environmentTag": {
            "type": "string",
            "metadata": {
                "description": "Environment Resource Tag"
            },
            "allowedValues": [
                "Core",
                "Dev",
                "Test",
                "Lab"
            ]
        }
    },
    "variables": {
        "linkedTemplateContainerUri": "https://raw.githubusercontent.com/FabienGilbert/AzureHub/master/linkedTemplates",
        "leftPrefix": "[concat(parameters('EnterprisePrefix'), '-', parameters('RegionPrefix'), '-', parameters('EnvironmentPrefix'), '-')]",
        "nsgRgp": "[concat(variables('leftPrefix'),'NSG-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
        "nsgName": "[concat(variables('leftPrefix'), 'SNT-DS-', replace(parameters('addsSubnetPrefix'), '/', '_'))]",
        "nsgTags": {
            "Component": "Network Security Group",
            "Application": "[parameters('applicationTag')]",
            "Environment": "[parameters('environmentTag')]"
        },
        "logRgp": "[concat(parameters('EnterprisePrefix'), '-', parameters('LogWksRegionPrefix'), '-', parameters('EnvironmentPrefix'), '-','LOG-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
        "logWksName": "[concat(parameters('EnterprisePrefix'), '-', parameters('LogWksRegionPrefix'), '-', parameters('EnvironmentPrefix'), '-','LOGWKS-',parameters('SubscriptionOrdinalPrefix'))]",
        "securityRules": {
            "value": [                                
                {
                    "direction": "inbound",
                    "priority": 200,
                    "name": "AllowInBoundIntraSubnetTraffic",
                    "description": "Allow InBound Intra-Subnet Traffic InBound",
                    "access": "allow",
                    "protocol": "*",
                    "sourceAddressPrefix": "[parameters('addsSubnetPrefix')]",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "inbound",
                    "priority": 210,
                    "name": "AllowJumpServersInBound",
                    "description": "Allow Jump Servers InBound",
                    "access": "allow",
                    "protocol": "*",
                    "sourceAddressPrefix": "[parameters('jumpSrvSubnetPrefix')]",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "inbound",
                    "priority": 220,
                    "name": "AllowInBoundActiveDirectoryTCP",
                    "description": "Allow InBound Active Directory TCP traffic from the Subnets to the Domain Controllers",
                    "access": "allow",
                    "protocol": "tcp",
                    "sourceAddressPrefix": "[parameters('environmentSupernet')]",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "",
                    "destinationPortRanges": [
                        "53",
                        "88",
                        "135",
                        "137-139",
                        "389",
                        "445",
                        "464",
                        "636",
                        "3268",
                        "3269",
                        "49152-65535"
                    ]
                },
                {
                    "direction": "inbound",
                    "priority": 230,
                    "name": "AllowInBoundActiveDirectoryUDP",
                    "description": "Allow InBound Active Directory UDP traffic from the Subnets to the Domain Controllers",
                    "access": "allow",
                    "protocol": "udp",
                    "sourceAddressPrefix": "[parameters('environmentSupernet')]",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "",
                    "destinationPortRanges": [
                        "53",
                        "88",
                        "123",
                        "137-139",
                        "389",
                        "464",
                        "49152-65535"
                    ]
                },
                {
                    "direction": "inbound",
                    "priority": 1980,
                    "name": "DenyInBoundVnetUDP",
                    "description": "Deny Inbound UDP Traffic from all Azure and on-premises subnets.",
                    "access": "deny",
                    "sourceAddressPrefix": "VirtualNetwork",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "protocol": "udp",
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "inbound",
                    "priority": 1990,
                    "name": "DenyInBoundVnetTCP",
                    "description": "Deny Inbound TCP Traffic from all Azure and on-premises subnets.",
                    "access": "deny",
                    "sourceAddressPrefix": "VirtualNetwork",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "protocol": "tcp",
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "outbound",
                    "priority": 200,
                    "name": "AllowOutBoundIntraSubnetTraffic",
                    "description": "Allow OutBound Intra-Subnet Traffic InBound",
                    "access": "allow",
                    "protocol": "*",
                    "sourceAddressPrefix": "VirtualNetwork",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "[parameters('addsSubnetPrefix')]",
                    "destinationAddressPrefixes": [],
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "outbound",
                    "priority": 1980,
                    "name": "DenyOutBoundVnetTCP",
                    "description": "Deny Outbound TCP Traffic to all Azure and on-premises subnets.",
                    "access": "deny",
                    "sourceAddressPrefix": "VirtualNetwork",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "protocol": "tcp",
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                },
                {
                    "direction": "outbound",
                    "priority": 1990,
                    "name": "DenyOutBoundVnetUDP",
                    "description": "Deny Outbound UDP Traffic to all Azure and on-premises subnets.",
                    "access": "deny",
                    "sourceAddressPrefix": "VirtualNetwork",
                    "sourceAddressPrefixes": [],
                    "destinationAddressPrefix": "VirtualNetwork",
                    "destinationAddressPrefixes": [],
                    "protocol": "udp",
                    "sourcePortRange": "*",
                    "sourcePortRanges": [],
                    "destinationPortRange": "*",
                    "destinationPortRanges": []
                }
            ]
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "[concat('hubNsg_', variables('nsgName'))]",
            "resourceGroup": "[variables('nsgRgp')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('linkedTemplateContainerUri'), '/nsg_armTemplate.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "networkSecurityGroupName": {
                        "value": "[variables('nsgName')]"
                    },
                    "securityRules": {
                        "value": "[variables('securityRules')]"
                    },
                    "logAnalyticsWorkspaceResourceGroup": {
                        "value": "[variables('logRgp')]"
                    },
                    "logAnalyticsWorkspaceName": {
                        "value": "[variables('logWksName')]"
                    },
                    "tags": {
                        "value": "[variables('nsgTags')]"
                    }
                }
            }
        }
    ]
}