{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "tenantId": {
      "type": "string",
      "metadata": {
        "description": "Specify the Azure AD Tenant ID."
      }
    },
    "subscriptionId": {
      "type": "string",
      "metadata": {
        "description": "Specify the Hub subscription ID."
      }
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Specify the location for the deployment, resource group and resources."
      }
    },
    "logWkslocation": {
      "type": "string",
      "metadata": {
        "description": "Specify the location for the Log Analytics Workspace"
      }
    },
    "RegionPrefix": {
      "type": "string",
      "metadata": {
        "description": "Specify the Region prefix that will be added to all Resource Group and Resource names."
      }
    },
    "LogWksRegionPrefix": {
      "type": "string",
      "metadata": {
        "description": "Specify the Region prefix that will be added to the Log Analytics Resource Group."
      }
    },
    "EnterprisePrefix": {
      "type": "string",
      "metadata": {
        "description": "Specify the enterpise prefix that will be added to all Resource Group and Resource names.."
      }
    },
    "EnvironmentPrefix": {
      "type": "string",
      "metadata": {
        "description": "Specify the environment prefix that will be added to all Resource Group and Resource names.."
      },
      "allowedValues": [
        "C",
        "D",
        "T",
        "L"
      ]
    },
    "SubscriptionOrdinalPrefix": {
      "type": "string",
      "metadata": {
        "description": "Specify the subscription ordinal prefix that will be added to all Resource Group and Resource names. For instance: S01"
      }
    },
    "addressPrefixes": {
      "type": "array",
      "metadata": {
        "description": "Address Prefixes that will be configured into the VNET."
      }
    },
    "gatewaySubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "Gateway VNET subnet prefix."
      }
    },
    "appGatewaySubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "AppGateway VNET subnet prefix."
      }
    },
    "firewallSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "Azure Firewall VNET subnet prefix."
      }
    },
    "addsSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "AD FS VNET subnet prefix."
      }
    },
    "jumpSrvSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "Jump server VNET subnet prefix."
      }
    },
    "adfsSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "Edge VNET subnet prefix."
      }
    },
    "appSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "App VNET subnet prefix."
      }
    },
    "wapSubnetPrefix": {
      "type": "string",
      "metadata": {
        "description": "Web Application Proxy VNET subnet prefix."
      }
    },
    "dnsServers": {
      "type": "array",
      "metadata": {
        "description": "DNS Servers that will be configured in the VNET."
      }
    },
    "keyVaultFullAccessGroupId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Group Id for full access Key Vault access policy"
      }
    },
    "keyVaultReadOnlyAccessGroupId": {
      "type": "string",
      "metadata": {
        "description": "Azure AD Group Id for read-only Key Vault access policy"
      }
    },
    "allowedOnPremsPublicIps": {
      "type": "array",
      "metadata": {
        "description": "On-premises Public IP Addresses allowed to connect through resources' firewall"
      },
      "defaultValue": []
    },
    "logAnalyticsTier": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace Tier"
      },
      "allowedValues": [
        "Free",
        "Standard",
        "Premium",
        "PerNode",
        "PerGB2018",
        "Standalone",
        "CapacityReservation"
      ],
      "defaultValue": "Free"
    },
    "logAnalyticsRetention": {
      "type": "int",
      "metadata": {
        "description": "Log Analytics Workspace Retention"
      },
      "defaultValue": 7
    },
    "applicationTag": {
      "type": "string",
      "metadata": {
        "description": "Application tag"
      }
    },
    "environmentTag": {
      "type": "string",
      "metadata": {
        "description": "Environment Resource Tag"
      },
      "allowedValues": [
        "Core",
        "Dev",
        "Test",
        "Lab"
      ]
    }
  },
  "variables": {
    "linkedTemplateContainerUri": "https://raw.githubusercontent.com/FabienGilbert/AzureHub/master/linkedTemplates",
    "leftPrefix": "[concat(parameters('EnterprisePrefix'), '-', parameters('RegionPrefix'), '-', parameters('EnvironmentPrefix'), '-')]",
    "nsgRgp": "[concat(variables('leftPrefix'),'NSG-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "netRgp": "[concat(variables('leftPrefix'),'NET-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "akvRgp": "[concat(variables('leftPrefix'),'AKV-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "logRgp": "[concat(parameters('EnterprisePrefix'), '-', parameters('LogWksRegionPrefix'), '-', parameters('EnvironmentPrefix'), '-','LOG-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "autoRgp": "[concat(variables('leftPrefix'),'AUTO-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "addsRgp": "[concat(variables('leftPrefix'),'ADDS-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "adfsRgp": "[concat(variables('leftPrefix'),'ADFS-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "jumpRgp": "[concat(variables('leftPrefix'),'JUMP-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "dnsRgp": "[concat(variables('leftPrefix'),'DNS-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "funcRgp": "[concat(variables('leftPrefix'),'FUNC-RGP-',parameters('SubscriptionOrdinalPrefix'))]",
    "resourceGroups": [
      {
        "name": "[variables('nsgRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Network Security Groups",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('netRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Network-related resources",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('akvRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Key Vaults",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('logRgp')]",
        "location": "[parameters('logWkslocation')]",
        "tags": {
          "Component": "Resource Group for Log Analytics-related resources",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('autoRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Automation-related resources",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('addsRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Active Directory Domain Services-related resources",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('adfsRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Active Directory Federation Services-related resources",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('jumpRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for jump servers",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('dnsRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for DNS zones",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "name": "[variables('funcRgp')]",
        "location": "[parameters('location')]",
        "tags": {
          "Component": "Resource Group for Azure Functions",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      }
    ],
    "logWksName": "[concat(parameters('EnterprisePrefix'), '-', parameters('LogWksRegionPrefix'), '-', parameters('EnvironmentPrefix'), '-','LOGWKS-',parameters('SubscriptionOrdinalPrefix'))]",
    "addsSubnetName": "[concat(variables('leftPrefix'), 'SNT-DS-', replace(parameters('addsSubnetPrefix'), '/', '_'))]",
    "jumpSubnetName": "[concat(variables('leftPrefix'), 'SNT-JP-', replace(parameters('jumpSrvSubnetPrefix'), '/', '_'))]",
    "adfsSubnetName": "[concat(variables('leftPrefix'), 'SNT-FS-', replace(parameters('adfsSubnetPrefix'), '/', '_'))]",
    "appSubnetName": "[concat(variables('leftPrefix'), 'SNT-AP-', replace(parameters('appSubnetPrefix'), '/', '_'))]",
    "wapSubnetName": "[concat(variables('leftPrefix'), 'SNT-RP-', replace(parameters('wapSubnetPrefix'), '/', '_'))]",
    "subnets": [
      {
        "name": "GatewaySubnet",
        "ipPrefix": "[parameters('gatewaySubnetPrefix')]",
        "nsgUdr": false,
        "serviceEndpoints": false
      },
      {
        "name": "AppGatewaySubnet",
        "ipPrefix": "[parameters('appGatewaySubnetPrefix')]",
        "nsgUdr": false,
        "serviceEndpoints": false
      },
      {
        "name": "AzureFirewallSubnet",
        "ipPrefix": "[parameters('firewallSubnetPrefix')]",
        "nsgUdr": false,
        "serviceEndpoints": false
      },
      {
        "name": "[variables('addsSubnetName')]",
        "ipPrefix": "[parameters('addsSubnetPrefix')]",
        "nsgUdr": true,
        "serviceEndpoints": true
      },
      {
        "name": "[variables('adfsSubnetName')]",
        "ipPrefix": "[parameters('adfsSubnetPrefix')]",
        "nsgUdr": true,
        "serviceEndpoints": true
      },
      {
        "name": "[variables('wapSubnetName')]",
        "ipPrefix": "[parameters('wapSubnetPrefix')]",
        "nsgUdr": true,
        "serviceEndpoints": true
      },
      {
        "name": "[variables('jumpSubnetName')]",
        "ipPrefix": "[parameters('jumpSrvSubnetPrefix')]",
        "nsgUdr": true,
        "serviceEndpoints": true
      },
      {
        "name": "[variables('appSubnetName')]",
        "ipPrefix": "[parameters('appSubnetPrefix')]",
        "nsgUdr": true,
        "serviceEndpoints": true
      }
    ],
    "copy": [
      {
        "name": "vnetSubnets",
        "count": "[length(variables('subnets'))]",
        "input": {
          "SubnetName": "[variables('subnets')[copyIndex('vnetSubnets')].name]",
          "addressPrefix": "[variables('subnets')[copyIndex('vnetSubnets')].ipPrefix]",
          "NsgResourceGroup": "[if(equals(variables('subnets')[copyIndex('vnetSubnets')].nsgUdr, json('true')), variables('nsgRgp'),'')]",
          "NsgName": "[if(equals(variables('subnets')[copyIndex('vnetSubnets')].nsgUdr, json('true')), concat(variables('subnets')[copyIndex('vnetSubnets')].name, '-NSG'),'')]",
          "UdrResourceGroup": "[if(equals(variables('subnets')[copyIndex('vnetSubnets')].nsgUdr, json('true')), variables('netRgp'),'')]",
          "UdrName": "[if(equals(variables('subnets')[copyIndex('vnetSubnets')].nsgUdr, json('true')), concat(variables('subnets')[copyIndex('vnetSubnets')].name, '-UDR'),'')]",
          "serviceEndpoints": "[if(equals(variables('subnets')[copyIndex('vnetSubnets')].serviceEndpoints, json('true')), variables('serviceEndpoints'),'')]"
        }
      }
    ],
    "serviceEndpoints": [
      {
        "service": "Microsoft.Storage"
      },
      {
        "service": "Microsoft.Keyvault"
      }
    ],
    "vnetName": "[concat(variables('leftPrefix'),'VNET-',parameters('SubscriptionOrdinalPrefix'),'-01')]",
    "virtualNetworkAcls": [
      {
        "VnetSubscriptionId": "[parameters('subscriptionId')]",
        "VnetResourceGroup": "[variables('netRgp')]",
        "VnetName": "[variables('vnetName')]",
        "VnetSubnet": "[variables('adfsSubnetName')]",
        "action": "allow"
      },
      {
        "VnetSubscriptionId": "[parameters('subscriptionId')]",
        "VnetResourceGroup": "[variables('netRgp')]",
        "VnetName": "[variables('vnetName')]",
        "VnetSubnet": "[variables('addsSubnetName')]",
        "action": "allow"
      },
      {
        "VnetSubscriptionId": "[parameters('subscriptionId')]",
        "VnetResourceGroup": "[variables('netRgp')]",
        "VnetName": "[variables('vnetName')]",
        "VnetSubnet": "[variables('jumpSubnetName')]",
        "action": "allow"
      },
      {
        "VnetSubscriptionId": "[parameters('subscriptionId')]",
        "VnetResourceGroup": "[variables('netRgp')]",
        "VnetName": "[variables('vnetName')]",
        "VnetSubnet": "[variables('wapSubnetName')]",
        "action": "allow"
      },
      {
        "VnetSubscriptionId": "[parameters('subscriptionId')]",
        "VnetResourceGroup": "[variables('netRgp')]",
        "VnetName": "[variables('vnetName')]",
        "VnetSubnet": "[variables('appSubnetName')]",
        "action": "allow"
      }
    ],
    "keyVaultAccessPolicy": [
      {
        "comments": "Full Access Group",
        "tenantId": "[parameters('tenantId')]",
        "objectId": "[parameters('keyVaultFullAccessGroupId')]",
        "permissions": {
          "keys": [
            "all"
          ],
          "secrets": [
            "all"
          ],
          "certificates": [
            "all"
          ]
        }
      },
      {
        "comments": "Read-Only Access Group",
        "tenantId": "[parameters('tenantId')]",
        "objectId": "[parameters('keyVaultReadOnlyAccessGroupId')]",
        "permissions": {
          "keys": [
            "WrapKey",
            "UnwrapKey",
            "Get",
            "List"
          ],
          "secrets": [
            "Get",
            "List"
          ],
          "certificates": [
            "Get",
            "List"
          ]
        }
      },
      {
        "comments": "Backup Management Service",
        "tenantId": "[parameters('tenantId')]",
        "objectId": "54778c7d-c234-4db5-8d56-b3026641e834",
        "permissions": {
          "keys": [
            "Get",
            "List",
            "Backup",
            "Restore"
          ],
          "secrets": [
            "Get",
            "List",
            "Backup",
            "Restore"
          ],
          "certificates": []
        }
      }
    ],
    "keyVaults": [
      {
        "name": "[concat(variables('leftPrefix'),'AKV-',parameters('SubscriptionOrdinalPrefix'),'-01')]",
        "enableVaultForDeployment": true,
        "enableVaultForDiskEncryption": true,
        "enabledForTemplateDeployment": true,
        "networkAclDefaultAction": "deny",
        "virtualNetworkAcls": "[variables('virtualNetworkAcls')]",
        "tags": {
          "Component": "Key Vault for deployment passwords, encryption keys and SSL certificates",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      }
    ],
    "storageAccounts": [
      {
        "resourceGroup": "[variables('autoRgp')]",
        "name": "[concat(toLower(parameters('EnterprisePrefix')), toLower(parameters('RegionPrefix')), toLower(parameters('EnvironmentPrefix')), 'autostor', toLower(parameters('SubscriptionOrdinalPrefix')), '01')]",
        "sku": "Standard_LRS",
        "tier": "Cool",
        "networkAclDefaultAction": "allow",
        "virtualNetworkAcls": [],
        "tags": {
          "Component": "Storage account for linked ARM templates and deployment config files",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      },
      {
        "resourceGroup": "[variables('nsgRgp')]",
        "name": "[concat(toLower(parameters('EnterprisePrefix')), toLower(parameters('RegionPrefix')), toLower(parameters('EnvironmentPrefix')), 'nsgstor', toLower(parameters('SubscriptionOrdinalPrefix')), '01')]",
        "sku": "Standard_LRS",
        "tier": "Cool",
        "networkAclDefaultAction": "deny",
        "virtualNetworkAcls": "[variables('virtualNetworkAcls')]",
        "tags": {
          "Component": "Storage account for NSG Flow Logs",
          "Application": "[parameters('applicationTag')]",
          "Environment": "[parameters('environmentTag')]"
        }
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "name": "[variables('resourceGroups')[copyIndex('rgpLoop')].name]",
      "copy": {
        "name": "rgpLoop",
        "count": "[length(variables('resourceGroups'))]"
      },
      "apiVersion": "2020-06-01",
      "location": "[variables('resourceGroups')[copyIndex('rgpLoop')].location]",
      "tags": "[variables('resourceGroups')[copyIndex('rgpLoop')].tags]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "[concat('logWks_', variables('logWksName'))]",
      "dependsOn": [
        "rgpLoop"
      ],
      "resourceGroup": "[variables('logRgp')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('linkedTemplateContainerUri'), '/logAnalyticsWorkspace_armTemplate.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[variables('logWksName')]"
          },
          "serviceTier": {
            "value": "[parameters('logAnalyticsTier')]"
          },
          "dataRetention": {
            "value": "[parameters('logAnalyticsRetention')]"
          },
          "tags": {
            "value": {
              "Component": "Log Analytics Workspace",
              "Application": "[parameters('applicationTag')]",
              "Environment": "[parameters('environmentTag')]"
            }
          }
        }
      }
    }
  ]
}